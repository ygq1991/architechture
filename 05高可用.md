# 05 | 复杂度来源：高可用

本质通过冗余来做到高可用 



![img](https://static001.geekbang.org/resource/image/77/b4/7793f8ae6230fbfaa2827086a9ead4b4.png)



## 计算高可用

机器无状态

* 需要增加一个任务分配器，需要综合考虑性能，成本可维护性，可用性
* 任务分配器和服务器之间有连接，需要选择合适的连接方式，并管理连接
* 任务分配器需要增加分配算法，常见的分配算法有
  * 主备
    * 冷备
    * 热备
    * 温备
  * 主主



zk采用 1主多备， memcache才用 全主0备





## 存储高可用

讲数据从一台机器搬到另一台机器上，需要经过线路进行传输



由于 数据+逻辑 = 业务



因此 存储 高可用的难点不在于如何备份数据，而在于减少或者规避数据不一致对业务造成的影响



CAP理论：  存储高可用不可能同时满足，一致性，可用性，分区容错性， 只能满足其中两个



#### 高可用状态决策



1. ##### 独裁式

   优点是不会出现决策混乱的问题，缺点是如果决策者挂了，整个系统无法做到准确的状态决策

   ![img](https://static001.geekbang.org/resource/image/f7/cf/f749a798fd189c9032f05f6eb41cdecf.png)

2. ##### 协商式

   最常用的主备决策，可以设计成

   * 2台服务启动时都是备机
   * 建立连接
   * 交换状态信息
   * 某一台决策作为主机，另一台继续作为备机



   难点在于信息交换出现问题，如何处理，

   * 备机在连接中断时，认为主机故障而升级成主机，但实际没有故障，变成了双主
   * 备机在连接中断时，认为主机没有故障，此时没有主机
   * 为了规避连接中断，采用多连接，如多个连接信息不一致，以谁为准

   ![img](https://static001.geekbang.org/resource/image/2d/11/2d6cd4d81842494c6583bfa227f53e11.png)

3. ##### 民主式

   ![img](https://static001.geekbang.org/resource/image/c5/d9/c5ac18b395e05be0fc336c1a4eb524d9.png)

   ​	zk采用Paxos算法， 算法复杂，采用多数取胜

   缺点是会脑裂，列如集群因为网络连接中断而被分成两个区，两个区都会选举出一个leader，

解决脑裂问题，则规定投票节点数必须大于一半节点，但若故障节点数超过一半,那就整个系统宕机了